# .github/workflows/test-action.yml
name: Test Action

on:
  pull_request:
    branches:
      - 'main'

jobs:
  test_with_manifest_file:
    name: "Test with manifestFile"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.5'

      - name: Build repo-slice binary
        run: go build -o ./repo-slice-test ./cmd/repo-slice

      - name: Create test manifest
        run: |
          echo "+ ." > test-manifest.txt
          echo "- go.mod" >> test-manifest.txt

      - name: Run repo-slice action
        id: slice
        uses: ./ # Uses the action in the current repository
        with:
          manifestFile: 'test-manifest.txt'
          output: 'test-output'
          local-binary-path: ./repo-slice-test

      - name: Verify slice contents
        run: |
          echo "Verifying contents of ${{ steps.slice.outputs.slice-path }}..."
          ls -R ${{ steps.slice.outputs.slice-path }}
          # Check that a file that should be present exists
          test -f "${{ steps.slice.outputs.slice-path }}/README.md"
          # Check that a file that should have been excluded does not exist
          ! test -f "${{ steps.slice.outputs.slice-path }}/go.mod"

  test_with_inline_manifest:
    name: "Test with inline manifest"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.5'

      - name: Build repo-slice binary
        run: go build -o ./repo-slice-test ./cmd/repo-slice

      - name: Run repo-slice action
        id: slice
        uses: ./ # Uses the action in the current repository
        with:
          manifest: |
            + .
            - go.mod
          output: 'test-output'
          local-binary-path: ./repo-slice-test

      - name: Verify slice contents
        run: |
          echo "Verifying contents of ${{ steps.slice.outputs.slice-path }}..."
          ls -R ${{ steps.slice.outputs.slice-path }}
          test -f "${{ steps.slice.outputs.slice-path }}/README.md"
          ! test -f "${{ steps.slice.outputs.slice-path }}/go.mod"

  test_with_temp_directory:
    name: "Test with temporary output directory"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.5'

      - name: Build repo-slice binary
        run: go build -o ./repo-slice-test ./cmd/repo-slice

      - name: Create test manifest
        run: |
          echo "+ ." > test-manifest.txt
          echo "- go.mod" >> test-manifest.txt

      - name: Run repo-slice action without output
        id: slice
        uses: ./
        with:
          manifestFile: 'test-manifest.txt'
          local-binary-path: ./repo-slice-test

      - name: Verify slice contents in temp dir
        run: |
          echo "Verifying contents of ${{ steps.slice.outputs.slice-path }}..."
          ls -R ${{ steps.slice.outputs.slice-path }}
          test -f "${{ steps.slice.outputs.slice-path }}/README.md"
          ! test -f "${{ steps.slice.outputs.slice-path }}/go.mod"

  test_for_failure:
    name: "Test for input validation failure"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run repo-slice action with both inputs
        # This step is expected to fail.
        id: slice
        uses: ./
        with:
          manifest: '+ .'
          manifestFile: 'manifest.txt'
          output: 'test-output'
        continue-on-error: true

      - name: Check failure status
        if: steps.slice.outcome != 'failure'
        run: |
          echo "Error: The action should have failed but it succeeded."
          exit 1